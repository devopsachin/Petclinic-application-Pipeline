import groovy.json.JsonSlurperClassic
import groovy.io.FileType

@Library('pet-clinic') _

pipeline{
 agent any
    environment{ 
    def props = readJSON file: 'resources/pet-clinic.json'
    applicationName = "${props.applicationName}"
    applicationPath = "${props.commonUrl}"
    dockerPath = "${props.dockerFilePath}"
    }
    
    stages{
        stage('cloning application repo'){
            steps{
                script{
                    pullGit(
                        branch: 'main',
                        url: "https://github.com/spring-projects/spring-petclinic.git"
                        )
			echo pwd
                    }
                }
                
            }
            stage('Build'){
                steps{
                    script{
		       mvnBuild 'validate'
                       mvnBuild 'package'
                    }
                }
                
            }
            stage ('Test'){
                steps{
                    script{
	               mvnBuild 'test'
	                    }
                }
            post {
			  always{
				 junit "$applicationPath/TEST-*.xml"
			  }
		  }
		
            }
	    stage ('Push to Docker'){
	    	steps{
		 script{
		 	dockerBuild.login()
			dockerBuild.build("${workspace}@script/resources", "3mmmm123/pet-clinic:$BUILD_NUMBER")
			dockerBuild.push ("3mmmm123/pet-clinic:$BUILD_NUMBER")
			}
		}
	    }
	    stage('Deploy'){
	    	steps{
			script{
			remoteSSH.ssh("ec2-3-110-212-169.ap-south-1.compute.amazonaws.com", "ubuntu")
			//code here
			}
			}
			}
            }
        }
